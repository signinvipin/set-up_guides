Set-up Elasticsearch, Kibana, and logstash
------------------------------------------
ref -
https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-with-rpm#rpm-repo
https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-kibana-with-rpm#rpm-running-systemd
https://www.elastic.co/docs/reference/logstash/installing-logstash#_yum

> Elasticsearch 7.17.x is the latest available for Centos8
> OpenJDK-11 is compatible with Elasticsearch 7.17.x
> Kibana 7.17.x is compatible with Elasticsearch 7.17.29
> Logstash 7.17.x compatible with Elasticsearch 7.17.29
> Check for compatibility - https://www.elastic.co/support/matrix#matrix_jvm

Hardware requirements -
4gb ram, 2core cpu, 50gb storage - test purpose
8gb ram, 4core cpu, 50 gb storage - test purpose

## Mirror Cmds Centos ##
$ sudo su
$ sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
$ sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
$ yum install epel-release -y

$ yum update -y

## Install openJdk-11
$ mv jdk-11.tar.gz /opt
set-up env
$ vi ~/.bashrc
add
# Java
export JAVA_HOME=/opt/jdk-11.0.19
export PATH=$PATH:$JAVA_HOME/bin

## Elasticsearch setup

> Install from the RPM repository -
create file 'elasticsearch.repo' in directory '/etc/yum.repos.d/' (for red hat) or '/etc/zypp/repos.d/' for openSUSE with below content

[elasticsearch]
name=Elasticsearch repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/7.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=0
autorefresh=1
type=rpm-md

> Install elasticsearch using below command - 
For centos and red hat
$ sudo yum install --enablerepo=elasticsearch elasticsearch

------skip-------
If repo is 'enabled=1', then we only execute below cmd and the elasticsearch will
also update with all other repositories when we do 'yum update'
$ sudo yum install elasticsearch

For openSuSe ---
$ sudo zypper modifyrepo --enable elasticsearch
$ sudo zypper install elasticsearch
$ sudo zypper modifyrepo --disable elasticsearch

> Install Elasticsearch the RPM manually
$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-9.0.3-x86_64.rpm
$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-9.0.3-x86_64.rpm.sha512
$ shasum -a 512 -c elasticsearch-9.0.3-x86_64.rpm.sha512
$ sudo rpm --install elasticsearch-9.0.3-x86_64.rpm

> Set up the node for connectivity and Set up a node as the first node in a cluster - 
Edit 'elasticsearch.yaml' present at (maybe here) '/etc/elasticsearch/elasticsearch.yml'
$ cd /etc/elasticsearch
$ vi elasticsearch.yaml/yml

change/set values of keys as below and save changes (not needed if installing kibana)
network.host: 0.0.0.0 
http.port: 9200
discovery.node: single-node 

#Copy the terminal output from the install command to a local file. In particular, you’ll need the password for #the built-in elastic superuser account. The output also contains the commands to enable Elasticsearch to run #as a service (https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-with-#rpm#running-systemd).
-----skip-----------

> Start Elasticsearch automatically
$ sudo systemctl daemon-reload
$ sudo systemctl enable elasticsearch.service

> Run Elasticsearch with systemd
$ sudo systemctl start elasticsearch.service
$ sudo systemctl status elasticsearch.service
$ curl -XGET http://localhost:9200 (to )
$ sudo systemctl stop elasticsearch.service
$ sudo systemctl restart elasticsearch


visit - https://server-ip:9200


## kibana setup

Install Kibana-7.17.29 with RPM

> Install from the RPM repository
create a file 'kibana.repo' at '/etc/yum.repos.d/'
$ vi /etc/yum.repos.d/kibana.repo
add

[kibana-7.X]
name=Kibana repository for 7.x packages
baseurl=https://artifacts.elastic.co/packages/9.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md

> Install kibana and update cache
$ yum update -y (if needed)
$ sudo yum install kibana

> (if needed) Set up the node for connectivity/accessability
Edit 'kibana.yml' present at (maybe here) '/etc/kibana/kibana.yml'
sudo nano /etc/kibana/kibana.yml
or
$ cd /etc/elasticsearch
$ vi kibana.yml

change/set values of keys as below and save changes - 
server.host: 0.0.0.0 (for open accesses from anywhere)

> Enable Kibana with systemd
$ systemctl daemon-reload
$ systemctl enable kibana.service

> Start/Stop kibana 
$ systemctl start kibana.service
$ systemctl stop kibana.service

> Check status kibana
$ systemctl status kibana

visit - http://<ec2-server-ip>:5601/

--
Step 1: Add Elasticsearch Connection Settings

- name: Set Elasticsearch host
  lineinfile:
    path: /etc/kibana/kibana.yml
    regex: '^elasticsearch.hosts:'
    line: 'elasticsearch.hosts: ["http://localhost:9200"]'

- name: Set Kibana to use a service account (optional)
  lineinfile:
    path: /etc/kibana/kibana.yml
    regex: '^elasticsearch.username:'
    line: 'elasticsearch.username: "kibana_system"'

- name: Set password for service account
  lineinfile:
    path: /etc/kibana/kibana.yml
    regex: '^elasticsearch.password:'
    line: 'elasticsearch.password: "your_password_here"'

Step 2: Enable Security (Optional but Recommended)

- name: Enable SSL for Elasticsearch
  lineinfile:
    path: /etc/kibana/kibana.yml
    regex: '^elasticsearch.ssl.verificationMode:'
    line: 'elasticsearch.ssl.verificationMode: full'

- name: Specify CA cert for SSL verification
  lineinfile:
    path: /etc/kibana/kibana.yml
    regex: '^elasticsearch.ssl.certificateAuthorities:'
    line: 'elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/ca.crt"]'
#We must have the CA cert file (ca.crt) already in place for this to work.

Add below before the daemon-reload task, and after the server.host config.

    - name: Set Elasticsearch host
      lineinfile:
        path: /etc/kibana/kibana.yml
        regex: '^elasticsearch.hosts:'
        line: 'elasticsearch.hosts: ["http://localhost:9200"]'

    - name: Set Elasticsearch username
      lineinfile:
        path: /etc/kibana/kibana.yml
        regex: '^elasticsearch.username:'
        line: 'elasticsearch.username: "kibana_system"'

    - name: Set Elasticsearch password
      lineinfile:
        path: /etc/kibana/kibana.yml
        regex: '^elasticsearch.password:'
        line: 'elasticsearch.password: "your_password_here"'

--

## Logstash

Installing from Package Repositories

> Import the public key
$ sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch

> Add repository
$ https://artifacts.elastic.co/packages/9.x/yum stable main
 or 
Create 'logstash.repo' file in '/etc/yum.repos.d/'
$ vi /etc/yum.repos.d/logstash.repo
add, (change the version number as if required)

[logstash-9.x]
name=Elastic repository for 9.x packages
baseurl=https://artifacts.elastic.co/packages/9.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md

> Update cache
$ yum update -y

> Install logstash
$ sudo yum install logstash

### Create configuration file
# Add Logstash Configuration Deployment
# If we're planning to manage the Logstash pipeline or config files, we may want to include tasks to:
#    Create config directory if needed.
#    Upload pipeline files via copy or template.
#    Restart Logstash after pushing configs.

# A custom Logstash configuration file defines how Logstash processes data. It tells Logstash:
  Where to get data from → input
  How to process/transform it → filter
  Where to send it → output

# Logstash config files go in: /etc/logstash/conf.d/
# Add this file and restart logstash
# /etc/logstash/conf.d/simple-pipeline.conf

#input {
#  beats {
#    port => 5044
#  }
#}

#filter {
#  if [fileset][module] == "nginx" {
#    grok {
#      match => { "message" => "%{COMBINEDAPACHELOG}" }
#    }
#  }
#}

#output {
#  elasticsearch {
#    hosts => ["http://localhost:9200"]
#    index => "logstash-%{+YYYY.MM.dd}"
#  }
#}

# Add yml code
# Add below when adding conf file for logstash 
#    - name: Configure Beats configuration file
#      template:
#        src: logstash.conf
#        dest: /etc/logstash/conf.d/logstash.conf
#        owner: root
#        group: root
#        mode: '0644'

> Load services
$ sudo systemctl daemon-reload

> Running Logstash by Using Systemd / start up Logstash
$ sudo systemctl start logstash.service

> enable logstash at startup
$ sudo systemctl enable logstash.service

